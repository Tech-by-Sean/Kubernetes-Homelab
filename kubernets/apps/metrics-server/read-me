Step 1: Enable Kubelet Certificate Rotation in Talos Configuration
For the Metrics Server to securely collect metrics from the kubelets, the kubelets need to present certificates that the Metrics Server trusts. The recommended approach in Talos is to enable kubelet certificate rotation. This must be applied to the machine configuration of all nodes (control plane and workers).


Retrieve Current Configuration: Use talosctl to retrieve your current machine configuration (MC) for a node. You'll need the IP address of a node (e.g., $NODE_IP) and your talosconfig.

Bash

talosctl get mc $NODE_IP -o yaml > controlplane.yaml # For a control plane node
# OR
talosctl get mc $NODE_IP -o yaml > worker.yaml # For a worker node
Edit the Configuration: Open the YAML file and add the rotate-server-certificates: true under machine.kubelet.extraArgs. You should also consider deploying a kubelet certificate approver (like kubelet-csr-approver) as an extra manifest to ensure the rotation is handled automatically.

Example Snippet to Add/Modify:

YAML

# ... other configuration above
machine:
  kubelet:
    extraArgs:
      # This enables automatic rotation of the Kubelet serving certificate
      rotate-server-certificates: true 
# ... other configuration below
Apply the Modified Configuration: Apply the updated configuration file to the respective node(s) and reboot to apply the changes. This is a non-disruptive, declarative process in Talos.

Bash

talosctl apply-config --nodes $NODE_IP --file controlplane.yaml
talosctl apply-config --nodes $NODE_IP --file worker.yaml # Repeat for all worker nodes
Note: For new clusters, you can include this snippet when generating your initial configuration files.

üöÄ Step 2: Deploy the Kubernetes Metrics Server
With the kubelet configured for certificate rotation, you can now deploy the Metrics Server itself. This is typically done using the official manifest.

Install Metrics Server: Apply the official components.yaml manifest from the Kubernetes SIGs repository. This manifest creates the necessary Deployment, Service, and RBAC resources in the kube-system namespace.

Bash

kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
Verify Deployment: Check that the Metrics Server pod is running and healthy:

Bash

kubectl get pods -n kube-system -l k8s-app=metrics-server
Wait for the pod status to show Running.

Verify Metrics API: Confirm that the Kubernetes API Aggregation layer has registered the metrics.k8s.io API.

Bash

kubectl get apiservices | grep metrics.k8s.io
The output should show a status of True under the AVAILABLE column:

v1beta1.metrics.k8s.io   kube-system/metrics-server   True    <age>
üñ•Ô∏è Step 3: Test with kubectl top and k9s
Once the Metrics Server is running and available, both kubectl top and k9s will be able to retrieve resource utilization data.

Test with kubectl top: Run the following commands to ensure metrics are being collected from the nodes and pods:

Bash

kubectl top nodes
kubectl top pods -A
If this works, you will see CPU and memory usage tables for your nodes and pods.

Test with k9s: Launch k9s:

Bash

k9s
You should now be able to see CPU and Memory utilization in the main pod/node views, and when using the pulses view (:pulses).
