ğŸš€ Kubernetes Metrics Server Deployment Guide (Talos Clusters)
This document outlines the two essential phases for successfully deploying the Kubernetes Metrics Server in a self-managed environment like Talos, including the mandatory infrastructure fix to ensure Kubelet certificate health and proper metric flow.
ğŸ“ Prerequisites

Working kubectl access to the target Talos cluster.
The Metrics Server manifest (metrics-server.yaml) must be pre-edited with the following performance/stability flags:

--kubelet-insecure-tls
--kubelet-preferred-address-types=InternalIP
--metric-resolution=15s




ğŸ“„ Phase 1: Deploy Metrics Server Application
This phase installs the Metrics Server pod using the custom, pre-configured manifest.
Step 1: Apply the Metrics Server Manifest
Apply the manifest directly from the Homelab repository.
bashkubectl apply -f https://raw.githubusercontent.com/Tech-by-Sean/Kubernetes-Homelab/refs/heads/main/kubernets/apps/metrics-server/metrics-server.yaml
Step 2: Verify Initial Pod Status
Check the status of the new pod in the kube-system namespace. It will likely be 0/1 READY until the certificate issue is addressed in Phase 2.
bashkubectl get pods -n kube-system -l k8s-app=metrics-server

ğŸ” Phase 2: Deploy Kubelet TLS Infrastructure Fix
This is the mandatory fix for the underlying "TLS internal error" that prevents the Metrics Server from scraping data. It deploys a controller to auto-approve Kubelet Certificate Signing Requests (CSRs).
Step 3: Deploy Kubelet Serving Cert Approver
Deploy the controller using the manifest from the Homelab repository.
bashkubectl apply -f https://raw.githubusercontent.com/Tech-by-Sean/Kubernetes-Homelab/main/kubernets/apps/metrics-server/kubelet-cert-approver
Step 4: Final Verification and Health Check
Wait 1-2 minutes for the approver to sign the Kubelet certificates. Confirm that the Metrics Server is ready and the metrics API is functional.
CommandExpected Success Resultkubectl get pods -n kube-system -l k8s-app=metrics-serverPod status must be 1/1 READY.kubectl top nodesMust display CPU and Memory utilization figures for all nodes.
Success Note: Once kubectl top nodes is working, cluster monitoring tools like k9s will be fully operational.

ğŸ—‘ï¸ Phase 3: Uninstall / Cleanup Procedure
To cleanly remove all components, use the following steps in reverse order.
Step 5: Uninstall the Kubelet Serving Cert Approver
Remove the approver controller first.
bashkubectl delete -f https://raw.githubusercontent.com/Tech-by-Sean/Kubernetes-Homelab/main/kubernets/apps/metrics-server/kubelet-cert-approver
Step 6: Uninstall the Metrics Server
Remove the Metrics Server application components.
bashkubectl delete -f https://raw.githubusercontent.com/Tech-by-Sean/Kubernetes-Homelab/refs/heads/main/kubernets/apps/metrics-server/metrics-server.yaml
Step 7: Verification (Optional)
You can confirm the complete removal by checking the API service:
bashkubectl get apiservice v1beta1.metrics.k8s.io
# Expected Output: Error from server (NotFound): apiservices.apiregistration.k8s.io "v1beta1.metrics.k8s.io" not found

